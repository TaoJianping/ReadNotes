### 学习目标

- 虚拟存储的需求背景
- 覆盖技术
- 交换技术
- 局部性原理
- 虚拟存储概念
- 虚拟页式存储
- 缺页异常



### 虚拟存储需求背景

- 计算机系统时常出现内存空间不够用的情况
- 为应用软件提供一个良好的内存的抽象



### 解决方法

- 覆盖（overlay）

  应用程序手动把需要的指令和数据保存到内存中

- 交换（swapping）

  操作系统把暂时不能执行的程序保存到外存中

- 虚拟存储

  在有限容量的内存中，以页为单位自动装入更多更大的程序



#### 局部性原理（principle of locality）

程序在执行过程中的一个较短时期，所执行的指令地址和指令的操作数地址，分别局限于一定区域

- 时间局限性

  一条指令的一次执行和下次执行，一个数据的一次访问和下次访问都集中在一个较短时期内

- 空间局部性

  当前指令和邻近的几条指令，当前访问的数据和邻近的几个数据都集中在一个较小的区域内

- 分支局部性

  一条跳转指令的两次执行，很可能跳到相同的内存位置

所以从理论上说，虚拟存储技术是能够实现的，而且可以取得满意的效果。



### 虚拟存储

##### 目标

![image](https://ws3.sinaimg.cn/large/005wgNfbgy1g5fvl2ruehj30g90570uf.jpg)

- 只把部分程序放到内存中，从而运行比物理内存大的程序
  - 由操作系统自动完成，无需程序员的干涉
- 实现进程在内存和外村之间的交换，从而获得更大的空闲内存空间
  - 在内存和外存之间只交换进程的部分内容



##### 思路

将不常用的部分内存块暂存到外存



##### 原理

- 装载程序时，只将当前指令执行需要的部分页面或段装入内存
- 指令执行中需要的指令或者数据不在内存（称为缺页或者缺段）时，处理器通知操作系统将相应的页面或者段调入内存
- 操作系统将内存中暂时不用的页面或者段保存到外存



##### 实现方式

- 虚拟页式存储
- 虚拟段式存储



##### 基本特征

- 不连续性
  - 物理内存分配非连续
  - 虚拟地址空间使用非连续
- 大用户空间
  - 提供给用户的虚拟内存可大于实际的物理内存
- 部分交换
  - 虚拟存储只对部分虚拟地址空间进行调入和调出



### 虚拟页式存储

在页式存储管理的基础上，增加请求调页和页面置换



##### 思路

- 当用户程序要装载到内存运行时，只装入部分页面，就启动程序运行
- 进程在运行中发现有需要的代码或数据不在内存时，则向系统发出缺页异常请求
- 操作系统在处理页异常时，将外存中相应的页面调入内存使得进程能继续运行



##### 虚拟页式存储中的地址转换

![image](https://ws1.sinaimg.cn/large/005wgNfbgy1g5fx1mc2k9j31200s04ik.jpg)

是在MMU当中进行的缺页异常，可以看到有个标志位会指明页是否有效来触发缺页异常

![image](https://wiki.osdev.org/images/9/9b/Page_table.png)



##### 虚拟页式存储中的外存管理

- 在何处保存未被映射的页？
  - 应能方便的找到在外存中的页面内容
  - 交换空间（磁盘或者文件，如Linux中的swap分区）
    - 采用特殊格式存储未被映射的页面
- 虚拟页式存储系统中的外存选择
  - 代码段：可执行二进制文件，直接指向可执行文件即可
  - 动态加载的共享库程序段：动态调用的库文件
  - 其他段：交换空间



##### 虚拟页式存储管理的性能

- 度量标准

  ![image](https://ws2.sinaimg.cn/large/005wgNfbgy1g5fxpbvhx0j31ds0oyx0p.jpg)



### 缺页异常

##### 定义

当发现页表项中的一项不在物理内存当中，就会触发缺页异常



##### 缺页异常的处理流程

![image](https://ws4.sinaimg.cn/large/005wgNfbgy1g5fxistuezj312v0nqax2.jpg)





### 参考

https://www.cnblogs.com/lanrenxinxin/p/4735027.html

[http://airtrack.me/posts/2015/04/27/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%88%86%E9%A1%B5%E5%92%8C%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/](http://airtrack.me/posts/2015/04/27/操作系统实现（二）：分页和物理内存管理/)