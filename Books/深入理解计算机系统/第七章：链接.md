# 第七章：链接

## 7.1 编译器驱动程序

```shell
linux> gcc -Og -o prog main.c sum.c
```



![image](https://tva1.sinaimg.cn/large/005wgNfbgy1gam0yxw99vj30gr0d1gpy.jpg)

一个普通的编译过程

- 驱动程序首先运行C预处理器（cpp），它讲C的源程序`main.c`翻译成一个ASCII码的中间文件`main.i`：

  ```shell
  cpp [other arguments] main.c /tmp/main.i
  ```

- 接下来，驱动程序运行C编译器（ccl），它将`main.i`翻译成一个ASCII汇编语言文件`main.s`：

  ```shell
  ccl /tmp/main.i -Og [other arguments] -o /tmp/main.s
  ```

- 然后，驱动程序运行汇编器（as），他将main.s翻译成一个可重定位目标文件（relocatable object file）`main.o`：

  ```shell
  as [other arguments] -o /tmp/main.o /tmp/main.s
  ```

- 最后，它运行链接器程序ld，将`main.o`和`sum.o`以及一些必要的系统目标文件组合起来，创建一个**可执行目标文件（executable object file）**prog：

  ```shell
  ld -o prog [system object files and args] /tmp/main.o /tmp/sum.o
  ```

shell调用操作系统中一个叫做**加载器（loader）**的函数，他将可执行文件prog中的代码和数据复制到内存，然后将控制转移到这个程序的开头。



## 7.2 静态链接

像Linux LD程序这样的**静态链接器（Static linker）**以一组可重定位目标文件和命令行参数作为输入，生成一个完全链接的、可以加载和运行的可执行目标文件作为输出。

- 符号解析（symbol resolution）
- 重定位（relocation）



## 7.3 目标文件

目标文件有三种形式：

- 可重定位目标文件
- 可执行目标文件
- 共享目标文件



## 7.4 可重定位目标文件

![image](https://tvax1.sinaimg.cn/large/005wgNfbgy1gam2387sawj30c70etgp8.jpg)

图7-3展示了一个典型的ELF可重定位目标文件。

书上还有简单的解释了各个段的作用。



## 7.5 符号和符号表

每个可重定位目标模块m都有一个符号表，它包含m定义和引用的符号的信息。在连接器的上下文中，有三种不同的符号：

- 有模块m定义并能被其他模块引用的全局符号。全局链接器符号对应于非静态的C函数和全局变量；
- 由其他模块定义并被模块m引用的全局符号。这些符号被称为外部符号，对应于在其他模块中定义的非静态C函数和全局变量。
- 只被模块m定义和引用的局部符号。他们对应于带static属性的C函数和全局变量。这些符号在模块m中任何位置都可见，但是不能被其他模块引用。

> **COMMON和.bss的区别**
>
> COMMON	未初始化的全局变量
>
> .bss				未初始化的静态变量，以及初始化为0的全局或静态变量



## 7.6 符号解析

### 7.6.1 链接器如何解析多重定义的全局符号

链接器的输入是一组可重定位目标模块，如果多个模块定义同名的全局符号，按照以下规则：

- 规则1：不允许有多个同名的强符号；
- 规则2：如果有一个强符号和多个弱符号同名，选择强符号；
- 规则3：如果有多个弱符号同名，那么从这些弱符号中任意选择一个（应该不是，是按照顺序来的好像。还有就是按照大小来？可以看程序员的自我修养那本书，讲的更好。）

>强符号：函数和已初始化的全局变量
>
>弱符号：未初始化的全局变量

#### COMMON段的实际用途

![image](https://tvax3.sinaimg.cn/large/005wgNfbly1gan4mgz1f8j30ol068ahs.jpg)

