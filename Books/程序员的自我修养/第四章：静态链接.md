# 第四章：静态链接

- 4.1 空间与地址分配
- 4.2 符号解析与重定位
- 4.3 COMMON块
- 4.4 C++相关问题
- 4.5 静态库链接
- 4.6 链接过程控制
- 4.7 BFD库
- 本章小结




```c++
/* a.c */
extern int shared;

int main() 
{
    int a = 100;
    swap(&a, &shared);
}
```

```c++
/* b.c */
int shared = 1;

void swap(int *a, int *b)
{
    *a ^= *b ^= *a ^= *b;
}
```

当上面两个文件a.c和b.c经过编译之后得到两个目标文件a.o和b.o，但是还没有经过链接，链接就是要把这两个文件链接起来形成可执行文件。



## 4.1 空间与地址分配

链接的第一个问题：

- 对于多个输入目标文件，连接器如何将他们的各个段合并到输出文件？或者说，输出文件中的空间如何分配给输入文件？



### 4.1.1 按序叠加

![image](https://tvax1.sinaimg.cn/large/005wgNfbgy1gaccv71x07j30f30jrjuv.jpg)

就是按照顺序把各个目标文件叠加在一起。零散的段太多了，还浪费空间，造成很多的内存碎片



### 4.1.2 相似段合并

将相似的段合并到一起。

![image](https://tvax4.sinaimg.cn/large/005wgNfbgy1gacd9pdgwej30e60ch41n.jpg)



“链接器为目标文件分配地址和空间”，有两个含义：

- 在输出的可执行文件中的空间
- 在装载后的虚拟地址中的虚拟地址空间



现在都使用相似段合并，并一般使用**两步链接**的方法：

- 空间与地址分配
- 符号解析和重定位



### 4.1.3 符号地址的确定

当前⾯⼀步完成之后，链接器开始计算各个符号的虚拟地址。因为各个符号在段内的相对位置是固定的，所以这时候其实“main”、“shared”和“swap”的地址也已经是确定的了，只不过链接器须要给每个符号加上⼀个偏移量，使它们能够调整到正确的虚拟地址。



## 4.2 符号解析和重定位



### 4.2.1 重定位

在完成空间和地址的分配步骤之后，链接器就进入了符号解析与重定位的步骤，这也是静态链接的核心内容。

在链接器完成地址和空间分配之后就已经可以确定所有符号的虚拟地址了，那么链接器就可以根据符号的地址对每一个需要重定位的指令进行地位修正。



### 4.2.2 重定位表

3个问题

- 链接器是怎么知道哪些指令是要被调整的？
- 这些指令的哪些部分要被调整？
- 怎么调整？

事实上在ELF文件中，有一个叫**重定位表（Relocation Table）**的结构专门用来保存这些与重定位相关的信息。他在ELF文件中往往是多个段。

对于可重定位的ELF文件来说，他必须包含有重定位表，用来描述如何修改相应的段里的内容。对于每个要被重定位的ELF段都有一个对应的重定位表，而一个重定位表往往就是ELF文件中的一个段，所以其实重定位表也可以叫做重定位段，在这里我们统一称之为**重定位表**。比如代码段“.text”如有被重定位的地方，那么就有一个叫“.rel.text”的段保存了代码段的重定位表。

对于32位的Intel x86 系列处理器来说，重定位表的结构也很简单，他是一个Elf32_Rel结构的数组，每个数组元素对应一个重定位入口。

```c
typedef struct
{
  Elf32_Addr	r_offset;		/* Address */
  Elf32_Word	r_info;			/* Relocation type and symbol index */
} Elf32_Rel;
```

![image](https://tva3.sinaimg.cn/large/005wgNfbgy1gacoksiiy2j30td0czao7.jpg)



### 4.2.4 指令修正方式

不同的处理器指令对于地址的格式和方式都不一样。这些寻址方式有以下的区别：

- 近址寻址或远址寻址
- 绝对寻址或相对寻址
- 寻址长度为8位、16位、32位或64位



## 4.3 COMMON块

可能会出现一个符号定义在不同的文件定义多次，而且还有强符号和弱符号的定义，所以我们要分三种情况讨论：

- 两个或两个以上强符号类型不一致

  直接报错

- 有一个强符号，其他都是弱符号，出现类型不一致

  选强符号

- 有两个或两个以上弱符号，选类型最大的那个

未初始化的全局变量在符号表中会被归类为`SHN_COMMON`；为什么不直接像局部静态变量放在`.BSS`里面呢？因为他可能会被定义在多个文件中，不确定，所以无法直接在`.BSS`中分配空间。



## 4.5 静态库链接

静态库就是一组目标文件的集合，一般操作系统都会给User这样的一些库，封装好系统调用之后给用户使用。Linux下在`/usr/lib/lib.c`

