#  第十章：内存

## 10.1 程序的内存布局

- 用户空间
- 内核空间
- 栈：栈⽤于维护函数调⽤的上下⽂，离开了栈函数调⽤就没法实现。
- 堆：堆是⽤来容纳应⽤程序动态分配的内存区域，当程序使⽤malloc或new分配内存时，得到的内存来⾃堆⾥。
- 可执行文件映像：这⾥存储着可执⾏⽂件在内存⾥的映像（Chapter 6）
- 保留区：保留区并不是⼀个单⼀的内存区域，⽽是对内存中受到保护⽽禁⽌访问的内存区域的总称。
- 动态链接库映射区：“动态链接库映射区”，这个区域⽤于映射装载的动态链接库。在Linux下，如果可执⾏⽂件依赖其他共享库，那么系统就会为它在从0x40000000开始的地址分配相应的空间，并将共享库载⼊到该空间。

![image](https://tva4.sinaimg.cn/large/005wgNfbly1gaj85fpxrnj30i80og105.jpg)



## 10.2 栈与调用惯例

### 10.2.1 什么是栈

栈保存了⼀个函数调⽤所需要的维护信息，这常常被称为堆栈帧（Stack Frame）或活动记录
（Activate Record）。栈顶由esp指针进行定位。



#### 堆栈帧

- 函数的返回地址和参数
- 临时变量：包括函数的⾮静态局部变量以及编译器⾃动⽣成的其他临时变量。
- 保存的上下⽂：包括在函数调⽤前后需要保持不变的寄存器。



在i386中，⼀个函数的活动记录⽤ebp和esp这两个寄存器划定范围。esp寄存器始终指向栈的顶部，同时也就指向了当前函数的活动记录的顶部。⽽相对的，ebp寄存器指向了函数活动记录的⼀个固定位置，ebp寄存器又被称为帧指针（Frame Pointer）。⼀个很常见的活动记录⽰例如图10-4所⽰。

![image](https://tva3.sinaimg.cn/large/005wgNfbly1gaja2ez3ivj30k50a9t9q.jpg)

